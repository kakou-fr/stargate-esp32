<html>

<head>
  <!-- Chevrons from Manz: https:codepen.io/manz/pen/zoREJL -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <title>Stargate Command</title>
  <link rel="stylesheet" href="main.css" />
</head>

<body>
  <div class="dial-sequence">
  </div>

  <div class="chevrons">
    <div class="chevron" num="0"><img src="chevrons/001.svg" /></div>
    <div class="chevron" num="1"><img src="chevrons/002.svg" /></div>
    <div class="chevron" num="2"><img src="chevrons/003.svg" /></div>
    <div class="chevron" num="3"><img src="chevrons/004.svg" /></div>
    <div class="chevron" num="4"><img src="chevrons/005.svg" /></div>
    <div class="chevron" num="5"><img src="chevrons/006.svg" /></div>
    <div class="chevron" num="6"><img src="chevrons/007.svg" /></div>
    <div class="chevron" num="7"><img src="chevrons/008.svg" /></div>
    <div class="chevron" num="8"><img src="chevrons/009.svg" /></div>
    <div class="chevron" num="9"><img src="chevrons/010.svg" /></div>
    <div class="chevron" num="10"><img src="chevrons/011.svg" /></div>
    <div class="chevron" num="11"><img src="chevrons/012.svg" /></div>
    <div class="chevron" num="12"><img src="chevrons/013.svg" /></div>
    <div class="chevron" num="13"><img src="chevrons/014.svg" /></div>
    <div class="chevron" num="14"><img src="chevrons/015.svg" /></div>
    <div class="chevron" num="15"><img src="chevrons/016.svg" /></div>
    <div class="chevron" num="16"><img src="chevrons/017.svg" /></div>
    <div class="chevron" num="17"><img src="chevrons/018.svg" /></div>
    <div class="chevron" num="18"><img src="chevrons/019.svg" /></div>
    <div class="chevron" num="19"><img src="chevrons/020.svg" /></div>
    <div class="chevron" num="20"><img src="chevrons/021.svg" /></div>
    <div class="chevron" num="21"><img src="chevrons/022.svg" /></div>
    <div class="chevron" num="22"><img src="chevrons/023.svg" /></div>
    <div class="chevron" num="23"><img src="chevrons/024.svg" /></div>
    <div class="chevron" num="24"><img src="chevrons/025.svg" /></div>
    <div class="chevron" num="25"><img src="chevrons/026.svg" /></div>
    <div class="chevron" num="26"><img src="chevrons/027.svg" /></div>
    <div class="chevron" num="27"><img src="chevrons/028.svg" /></div>
    <div class="chevron" num="28"><img src="chevrons/029.svg" /></div>
    <div class="chevron" num="29"><img src="chevrons/030.svg" /></div>
    <div class="chevron" num="30"><img src="chevrons/031.svg" /></div>
    <div class="chevron" num="31"><img src="chevrons/032.svg" /></div>
    <div class="chevron" num="32"><img src="chevrons/033.svg" /></div>
    <div class="chevron" num="33"><img src="chevrons/034.svg" /></div>
    <div class="chevron" num="34"><img src="chevrons/035.svg" /></div>
    <div class="chevron" num="35"><img src="chevrons/036.svg" /></div>
    <div class="chevron" num="36"><img src="chevrons/037.svg" /></div>
    <div class="chevron" num="37"><img src="chevrons/038.svg" /></div>
    <div class="chevron" num="38"><img src="chevrons/039.svg" /></div>
  </div>

  <div class="animations">
    <div class="animation" anim="0">
      Chase
    </div>
    <div class="animation" anim="1">
      Ring
    </div>
    <div class="animation" anim="3">
      Clock
    </div>
  </div>

  <h2><center>start dialing</center></h2>
  <p>
    <div class="controls">
      <div class="control" onclick="compose_Abydos();">
        Abydos
      </div>
      <div class="control" onclick="compose_Asgard();">
        Asgard
      </div>
      <div class="control" onclick="compose_Destiny();">
        Destiny
      </div>
    </div>
  </p>

  <h1>Lights</h1>
  <p>
    <div class="controls">
      <div class="control" onclick="light_rainbow();">
        Rainbow
      </div>
      <div class="control" onclick="light_ramps();">
        Ramps
      </div>
      <div class="control" onclick="light_chevrons();">
        Chevrons
      </div>
    </div>
  </p>

  <h1>Calibration / Test</h1>
  <p>
    <div class="controls">
      <div class="control" onclick="calibrate();">
        Calibrate
      </div>
    </div>
  </p>

  <p>start Chevron stepper</p>
  <p><a href=\"/CF/on\"> <button class=\"button\">10 steps</button></a></p>

  <p><a href=\"/CB/on\"> <button class=\"button button2\">10 steps</button></a></p>


  <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js">
  </script>
  <script type="text/javascript">

    let dialSeq = [];
    let enableDialing = true;
    let enableRainbow = true;
    let enableRamp = true;
    let enableChevrons = true;
    let checkDialingInt = 0;

    var active = false;

    $('.control').on('click', function(){
      if(active == false) {
        $(this).css('background-color', 'red');
        active = true;
      } else {
        $(this).css('background-color', 'black');
        active = false;
      }
    });

    function checkDialing() {
      $.post({
          url: 'http://192.168.4.31/dialstatus'
        })
        .done(function(data, status, xhr) {
          if (xhr.status === 204) {
            clearInterval(checkDialingInt);

            dialSeq = [];
            $('.dial-sequence').html('');
            $('.dial-sequence').removeClass('dialing');
            enableDialing = true;
          }
        });
    }

    function dial() {
      enableDialing = false;

      $('.dial-sequence').addClass('dialing');

      $.post({
          url: 'http://192.168.4.31/update',
          data: JSON.stringify({
            anim: 2,
            sequence: dialSeq
          })
        })
        .done(function() {
          checkDialingInt = setInterval(checkDialing, 2000);
        })
        .fail(function() {
          alert('Could not send dialling sequence!');
          dialSeq = [];
          $('.dial-sequence').html('');
          $('.dial-sequence').removeClass('dialing');
          enableDialing = true;
        });
    }

    function light_rainbow() {

      if (enableRainbow) {
        enableRainbow = false;
        $.post({
          url: 'http://192.168.4.31/RAINBOW/on'
        });
      } else {
        enableRainbow = true;
        $.post({
          url: 'http://192.168.4.31/RAINBOW/off'
        });
      }
    }

    function light_ramps() {
      if (enableRamp) {
        enableRamp = false;
        $.post({
          url: 'http://192.168.4.31/Ramp_Lights/on'
        });
      } else {
        enableRamp = true;
        $.post({
          url: 'http://192.168.4.31/Ramp_Lights/off'
        });
      }
    }

    function light_chevrons() {
      if (enableChevrons) {
        enableChevrons = false;
        $.post({
          url: 'http://192.168.4.31/Ramp_Chevrons/on'
        });
      } else {
        enableChevrons = true;
        $.post({
          url: 'http://192.168.4.31/Ramp_Chevrons/off'
        });
      }
    }

    function compose_Abydos() {
      $.post({
        url: 'http://192.168.4.31/dialing/on/Abydos'
      });
    }

    function compose_Asgard() {
      $.post({
        url: 'http://192.168.4.31/dialing/on/Asgard'
      });
    }

    function compose_Destiny() {
      $.post({
        url: 'http://192.168.4.31/dialing/on/Destiny'
      });
    }

    function calibrate() {
      $.post({
        url: 'http://192.168.4.31/calibrate'
      });
    }

    $('div.chevrons div.chevron').click(function() {
      if (!enableDialing)
        return;

      const num = +$(this).attr('num');
      const html = $(this).clone().wrap('<div/>').parent().html();

      const existing = dialSeq.findIndex(function(s) {
        return s === num;
      });
      if (existing >= 0)
        return;

      dialSeq.push(num);
      const newChevron = $(html);
      newChevron.attr('style', 'transform: rotate(0);');
      $('.dial-sequence').append(newChevron);
      setTimeout(function() {
        newChevron.addClass('show');
      }, 10);

      if (dialSeq.length === 7) {
        enableDialing = false;
        setTimeout(function() {
          dial();
        }, 1200);
      }
    });

    $('div.animations div.animation').click(function() {
      const anim = +$(this).attr('anim');

      $.post({
          url: 'http://192.168.4.31/update',
          data: JSON.stringify({
            anim: anim
          })
        })
        .fail(function() {
          alert('Could not send animation request!');
        });
    });
  </script>
</body>

</html>
